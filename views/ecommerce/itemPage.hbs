<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Item Page</title>
    <link href="https://fonts.googleapis.com/css2?family=Didact+Gothic&display=swap" rel="stylesheet">     
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/ecommerce/essentials.css">
    <style type="text/css">
        .container {
            max-width: 1200px;
            margin: auto;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            padding-bottom: 2rem;
        }

        .imgSlider {
            margin-top: 40px;
            display: flex;
            align-items: center;
            flex-direction: column;
        }

        .imgSlider > img {
            max-width: 100%;
            max-height: 100%;
            height: 500px;
        }

        .imgSlider > div {
            margin-top: 2rem;
        }

        .imgSlider > div > span {
            display: inline-block;
            cursor: pointer;
            height: 13px;
            width: 13px;
            border-radius: 50%;
            background: lightgrey;
            border: 1px solid white;
        }

        .imgSlider > div > span.active {
            background: #EB5757;
        }

        .grid > *:nth-child(2) {
            width: 333px;
            max-width: 98%;
            margin: auto;
            border: 1px solid #E0E0E0;
            box-sizing: border-box;
            border-radius: 5px;
            margin-top: 14px;
            padding-top: 15px;
            padding-bottom: 27px;
        }

        .details > * {
            padding: 0 19px;
        }

        .cartItem {
            border-top: 1px solid #F2F2F2;
            border-bottom: 1px solid #F2F2F2;
            margin-bottom: 1rem;
            position: relative;
            background: whitesmoke;
        }

        .cartItem > p {
            font-size: 18px;
        }


        .cartItem > svg {
            position: absolute;
            right: 24px;
            bottom: 23px;
        }

        .cartItem > svg:not(.info-circle) {
            cursor: pointer;
            position: absolute;
            right: 19px;
            top: 11px;
        }

        .details > h1 {
            font-family: 'Didact Gothic';
            font-weight: 300;
            font-size: 38px;
            color: #333333;
            line-height: 0;
            margin-bottom: 3rem;
        }

        .details > p {
            line-height: 1.5;
            margin-top: 30px;
            font-size: 18px;
            color: #828282;
        }

        .sizes { 
            display: flex;
            flex-wrap: wrap;
            max-width: 90%;
        }

        .quantity span, .sizes span {
            height: 36px;
            width: 24px;
            padding-top: 1px;
            display: inline-block;
            padding: 0 6px;
            margin-right: 3px;
            margin-bottom: 3px;
            border: 1px solid white;
            border-radius: 5px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
        }

        span.active {
            background: #Eb5757;
            color: white;
            border: 1px solid #EB5757;
            font-weight: bold;
        }

        .size-guide > button {
            width: auto;
            padding: 2px 9px;
            font-size: 14px;
            color: darkcyan;
            /* font-weight: bold; */
            background: white;
        }

        .details span:hover {
            cursor: pointer;
        }

        .details span.disabled:hover {
            cursor: not-allowed;
        }

        .details span.disabled {
            opacity: 0.1;
        }

        .d-flex {
            display: flex;
        }

        .mt-8 {
            margin-top: 8px;
        }

        bold {
            font-weight: bold;
            color: #333333;
        }

        .d-none {
            display: none;
        }

        .show-size-guide {
            overflow: scroll;
        }

        .show-size-guide > table {
            min-width: 100%;
            border: 1px solid white;
            background: white;
            border-radius: 5px;
            font-size: 14px;
            color: #333333;
            border-collapse: collapse;
        }

        .show-size-guide > table tr:nth-child(1) {
            font-weight: bold;
        }

        .show-size-guide > table td {
            border: 1px solid whitesmoke;
            padding: 3px 8px;
            white-space: nowrap;
        }

        @media only screen and (max-width: 600px) {
            .grid {
                grid-template-columns: 1fr;
                padding: 12px;
            }

            .imgSlider {
                margin-top: 0px;
            }

            .imgSlider > img {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <nav>

        <div class="left">
            <a href="/{{data.brand}}/gen/page/landingPage/n">
                <img src="{{split0 data.resources.[0].logo}}" height="44">
            </a>
            <p>
            <span>·</span>
            <a href="/{{data.brand}}/gen/page/landingPage/n">Home</a>
            /
            <a href="/{{data.brand}}/gen/page/itemPage/{{data.item.[0]._id}}" class="active">{{data.item.[0].name}}</a>
            </p>
        </div>

        <div class="right">
            <a href="/{{data.brand}}/gen/page/findOrderPage/n">Find Order</a>
            <a href="/{{data.brand}}/gen/page/cartPage/n"><span>Cart</span><span class="cartBtn">{{data.countCart}}</span></a>
        </div>
    
    </nav>

    <section class="container grid">

        <div class="imgSlider">
            {{#each (split data.item.[0].imgURL)}}
            <img id="index{{@index}}" class="{{#unless (matchValues @index 0)}}d-none{{/unless}}" src="{{this}}" alt="">
            {{/each}}
            <div>
            {{#each (split data.item.[0].imgURL)}}
            <span connectedImg="index{{@index}}" class="{{#if (matchValues @index 0)}}active{{/if}}"></span>
            {{/each}}
            </div>
        </div>

        <div class="details">

            <h1>{{data.item.[0].name}}</h1>
            
            <p class="brief">
            {{data.item.[0].school}} · {{data.item.[0].category}} · <bold>PKR {{data.item.[0].cost}}</bold>
            </p>

            <p>Beautifully crafted shoes, hand crafted and styled to meet the elegant requirement of a student.</p>

            {{#unless data.itemInCart}}

            <div class="cartItem">

                <p><bold>Select a size to update your cart.</bold></p>
            
                <p class="qtyLabel">Max Quantity: {{data.item.[0].quantity}} ({{data.item.[0].size}})</p>

                <p class="quantity d-flex" id="quantity1" quantity="1" max-quantity="{{data.item.[0].quantity}}">
                    <span onclick="minusOne(this)">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 14H5V12H19V14Z" fill="#333333"/>
                    </svg>
                    </span>
                    <span class="active">1</span>
                    <span onclick="addOne(this)">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 13H13V19H11V13H5V11H11V5H13V11H19V13Z" fill="#333333"/>
                    </svg>
                    </span>
                </p>

                <p>Size</p>

                <p class="sizes">
                    {{#each data.item.[0].allSizes}}
                        <!-- name, maxQty, imgURL, school, category, cost -->
                        <span 
                           cartId="{{../data.mongoID}}"
                           myId="{{this._id}}"
                           connectingID="{{this.connectingID}}"
                           name="{{this.name}}" 
                           maxQty="{{this.quantity}}" 
                           imgURL="{{this.imgURL}}" 
                           school="{{this.school}}" 
                           category="{{this.category}}" 
                           cost="{{this.cost}}" 
                           size="{{this.size}}" 
                           my-data="{{this.quantity}} x items available"
                           class="
                           info-circle
                           {{#if (matchValues this.size ../data.item.[0].size)}} active {{/if}}
                           {{#if (matchValues this.quantity 0)}} disabled {{/if}}
                           "
                       >
                            {{size}}
                        </span>
                    {{/each}}
                </p>

                <p class="size-guide" my-brand="{{data.brand}}" my-category="{{data.item.[0].category}}">
                    <button class="d-none" onclick="hideSizeGuide(this)">Hide Size Guide</button>
                    <button class="" onclick="showSizeGuide(this)">View Size Guide</button>
                </p>

                <p class="show-size-guide"></p>

                <svg class="removeItem d-none" onclick="removeItem(this)" width="34" height="34" viewBox="0 0 34 34" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g clip-path="url(#clip0)">
                    <path d="M21.2133 14.1421L19.7991 12.7279L16.9707 15.5563L14.1423 12.7279L12.7281 14.1421L15.5565 16.9705L12.7281 19.7989L14.1423 21.2131L16.9707 18.3847L19.7991 21.2131L21.2133 19.7989L18.3849 16.9705L21.2133 14.1421ZM24.0418 9.89944C20.1385 5.99621 13.8029 5.99621 9.89964 9.89944C5.99641 13.8027 5.99641 20.1383 9.89964 24.0416C13.8029 27.9448 20.1385 27.9448 24.0418 24.0416C27.945 20.1383 27.945 13.8027 24.0418 9.89944ZM11.3138 22.6274C8.19551 19.509 8.19551 14.432 11.3138 11.3137C14.4322 8.19531 19.5092 8.19531 22.6276 11.3137C25.7459 14.432 25.7459 19.509 22.6276 22.6274C19.5092 25.7457 14.4322 25.7457 11.3138 22.6274Z" fill="#333333"></path>
                    </g>
                    <defs>
                    <clipPath id="clip0">
                    <rect width="24" height="24" fill="white" transform="translate(16.9707) rotate(45)"></rect>
                    </clipPath>
                    </defs>
                </svg>

                <svg onclick="duplicateItem(this)" class="info-circle" my-data="Add another size"  width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M17 13L17 11L13 11L13 7L11 7L11 11L7 11L7 13L11 13L11 17L13 17L13 13L17 13ZM22 12C22 6.48 17.52 2 12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12ZM4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20C7.59 20 4 16.41 4 12Z" fill="#333333"/>
                </svg>

            </div>

            {{/unless}}

            {{#each data.itemInCart}}

            <div class="cartItem">

                <p><bold>Items in cart: {{this.quantity}}  x Size {{this.items.[0].size}}</bold></p>
            
                <p class="qtyLabel">Max Quantity: {{this.items.[0].quantity}} ({{this.items.[0].size}})</p>

                <p class="quantity d-flex" id="quantity{{@index}}" quantity="{{this.quantity}}" max-quantity="{{this.items.[0].quantity}}">
                    <span onclick="minusOne(this)">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 14H5V12H19V14Z" fill="#333333"/>
                    </svg>
                    </span>
                    <span class="active">{{this.quantity}}</span>
                    <span onclick="addOne(this)">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 13H13V19H11V13H5V11H11V5H13V11H19V13Z" fill="#333333"/>
                    </svg>
                    </span>
                </p>

                <p>Size</p>

                <p class="sizes">
                    {{#each ../data.item.[0].allSizes}}
                        <!-- name, maxQty, imgURL, school, category, cost -->
                        <span 
                           cartId="{{../this._id}}"
                           myId="{{this._id}}"
                           connectingID="{{this.connectingID}}"
                           name="{{this.name}}" 
                           maxQty="{{this.quantity}}" 
                           imgURL="{{this.imgURL}}" 
                           school="{{this.school}}" 
                           category="{{this.category}}" 
                           cost="{{this.cost}}" 
                           size="{{this.size}}" 
                           my-data="{{this.quantity}} x items available"
                           class="
                           info-circle
                           {{#if (matchValues this.size ../this.items.[0].size)}} active {{/if}}
                           {{#if (matchValues this.quantity 0)}} disabled {{/if}}
                           "
                       >
                            {{size}}
                        </span>
                    {{/each}}
                </p>

                <p class="size-guide" my-brand="{{../data.brand}}" my-category="{{this.items.[0].category}}">
                    <button class="d-none" onclick="hideSizeGuide(this)">Hide Size Guide</button>
                    <button class="" onclick="showSizeGuide(this)">View Size Guide</button>
                </p>

                <p class="show-size-guide"></p>
  
                <svg class="removeItem {{#if (matchValues @index 0)}}d-none{{/if}}" onclick="removeItem(this)" width="34" height="34" viewBox="0 0 34 34" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <g clip-path="url(#clip0)">
                    <path d="M21.2133 14.1421L19.7991 12.7279L16.9707 15.5563L14.1423 12.7279L12.7281 14.1421L15.5565 16.9705L12.7281 19.7989L14.1423 21.2131L16.9707 18.3847L19.7991 21.2131L21.2133 19.7989L18.3849 16.9705L21.2133 14.1421ZM24.0418 9.89944C20.1385 5.99621 13.8029 5.99621 9.89964 9.89944C5.99641 13.8027 5.99641 20.1383 9.89964 24.0416C13.8029 27.9448 20.1385 27.9448 24.0418 24.0416C27.945 20.1383 27.945 13.8027 24.0418 9.89944ZM11.3138 22.6274C8.19551 19.509 8.19551 14.432 11.3138 11.3137C14.4322 8.19531 19.5092 8.19531 22.6276 11.3137C25.7459 14.432 25.7459 19.509 22.6276 22.6274C19.5092 25.7457 14.4322 25.7457 11.3138 22.6274Z" fill="#333333"></path>
                    </g>
                    <defs>
                    <clipPath id="clip0">
                    <rect width="24" height="24" fill="white" transform="translate(16.9707) rotate(45)"></rect>
                    </clipPath>
                    </defs>
                </svg>

                {{#if (matchValues @index 0)}}
                <svg onclick="duplicateItem(this)" class="info-circle" my-data="Add another size"  width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M17 13L17 11L13 11L13 7L11 7L11 11L7 11L7 13L11 13L11 17L13 17L13 13L17 13ZM22 12C22 6.48 17.52 2 12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12ZM4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20C7.59 20 4 16.41 4 12Z" fill="#333333"/>
                </svg>
                {{/if}}


            </div>
        
            {{/each}}

            <div class="btns">
                <a href="/{{data.brand}}/gen/page/cartPage/n">
                    <button class="primary">Check Out</button>
                </a>
                <a href="/{{data.brand}}/gen/page/landingPage/n">
                    <button class="secondary mt-8">Continue Shopping</button>
                </a>
            </div>

        </div>
    
    </section>
    <div class="popover shadow"></div>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script type="text/javascript" src="/ecommerce/essentials.js"></script>
    <script type="text/javascript" src="/ecommerce/cartPage.js"></script>
    <script>
        let addOne = function(e) {
            let elem = $(e).closest('.quantity');
            let maxQty = elem.attr('max-quantity');
            let currentQty = Number( elem.attr('quantity') ) + 1 > maxQty ? maxQty : Number ( elem.attr('quantity') ) + 1;
            elem.attr('quantity',currentQty);
            elem.find('span.active').html(currentQty);

            let size = elem.closest('.cartItem').find('.sizes > span.active').attr('size');
            elem.closest('.cartItem')
                .children('p:eq(0)')
                .html(`<bold>Items in cart: ${currentQty} x Size ${size}`)
            // changeTotal(e);

            addMeToCart(e);
        };

        let minusOne = function(e) {
            let elem = $(e).closest('.quantity');
            let currentQty = elem.attr('quantity') - 1 < 1 ? 1 : elem.attr('quantity') - 1;
            elem.attr('quantity',currentQty);
            elem.find('span.active').html(currentQty);
            let size = elem.closest('.cartItem').find('.sizes > span.active').attr('size');
            elem.closest('.cartItem')
                .children('p:eq(0)')
                .html(`<bold>Items in cart: ${currentQty} x Size ${size}`)
            addMeToCart(e);
        };

        let changeTotal = function(e, firstLoad) {
            let elem = $(e).closest('.quantity');
            let currentQty = elem.attr('quantity');
            let itemCost = elem.closest('.item').find('.cost').attr('cost');
            let newCost = Number(currentQty) * Number(itemCost);
            elem
                .closest('.item')
                .find('.cost > h1')
                .html('PKR ' + newCost);
            changeGrandTotal(firstLoad);    
        }

        let removeItem = async function(elem) {
            try {
                let data = {myId: $(elem).closest('.cartItem').find('.sizes > span.active').attr('cartId')};
                console.log({data});
                await $.ajax({
                    method: "POST",
                    data: data,
                    url: "/{{data.brand}}/gen/data/removeItemFromCart/n",
                    success: (data) => console.log(data),
                    fail: (e) => console.log(e)
                });
            } catch(e) {
                console.log(e.responseText)
            }
            $(elem).closest('.cartItem').remove();
        }

        let toggleClass = function(elem) {
            $(elem.target).parent('.sizes').find('span').removeClass('active');
            $(elem.target).addClass('active');
        }

        let updateSize = function(elem) {
            toggleClass(elem);
            let name = $(elem.target).attr("name");
            let maxQty = $(elem.target).attr("maxQty");
            let imgURL = $(elem.target).attr("imgURL");
            let school = $(elem.target).attr("school");
            let category = $(elem.target).attr("category");
            let cost = $(elem.target).attr("cost");
            let size = $(elem.target).attr("size");
            let span = $(elem.target).closest('.details').find('.quantity > span');

            $(elem.target)
                .closest('.cartItem')
                .children('p:eq(0)')
                    .html(`<bold>Items in cart: 1 x Size ${size}`)
                .siblings('p:eq(0)')
                    .html(`Max Quantity:  ${maxQty} (${size})`)
                .siblings('p:eq(1)')
                    .attr({'max-quantity': maxQty, 'quantity': 1})
                    .find('span.active')
                        .html('1')
                .closest('.item')
                .find('img')
                    .attr({src: imgURL});

            addMeToCart(elem.target);

        }

        let duplicateItem = function(elem) {
            let parent = $(elem).closest('.cartItem');
            let newItem = parent.clone().insertAfter(parent);
            $.get('/{{data.brand}}/gen/data/getMongoId/n', mongoId => {
                console.log(mongoId);
                $(newItem).find('.sizes > span').get().map(val => $(val).attr({cartId: mongoId }) );
            })
            $(newItem).find('.removeItem').removeClass('d-none');
        }

        let readyDocument = function(elem) {
        }

        let addMeToCart = function(elem) {
            // console.log($(elem.target).closest('.details').find('.quantity').attr('quantity'));
            let data = {
                quantity: $(elem).closest('.cartItem').find('.quantity').attr('quantity'),
                itemId: $(elem).closest('.cartItem').find('.sizes > span.active').attr('myid'),
                connectingID: $(elem).closest('.cartItem').find('.sizes > span.active').attr('connectingID'),
                cartId: $(elem).closest('.cartItem').find('.sizes > span.active').attr('cartId'),
                cartStatus: 'open',
            };

            let findUndefined = Object.values(data).some(val => val == undefined);
            if (findUndefined) return console.log(Object.values(data));


            $.ajax({
                method: 'post',
                url: '/{{data.brand}}/gen/data/saveItemInCart/n',
                data: data,
                success: (data) => console.log(data),
                error: (err) => console.log(err)
            })
                
        };

        let slideImg = function(elem) {
            let connectedImg = $(elem.target).attr('connectedImg');
            $(elem.target).closest('div').find('span').removeClass('active');
            $(elem.target).addClass('active');
            $(elem.target).closest('.imgSlider').find('img').addClass('d-none');
            $(`#${connectedImg}`).removeClass('d-none');
        }

        $(document).on('click', '.sizes > span:not(.disabled)', updateSize);
        $(document).on('click', '.imgSlider > div  > span:not(.disabled)', slideImg);
        $(document).ready(readyDocument);
    
    
    </script>
</body>
</html>
